<UserControl x:Class="IGA_GUI_Module.View.DataAnalysisView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:viewModel="clr-namespace:IGA_GUI_Module.ViewModel"
             xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.WPF;assembly=LiveChartsCore.SkiaSharpView.WPF"
             xmlns:helix="clr-namespace:HelixToolkit.Wpf;assembly=HelixToolkit.Wpf"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="1400"
             d:DataContext="{d:DesignInstance Type=viewModel:DataAnalysisViewModel, IsDesignTimeCreatable=True}">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/IGA_MVVM_Module;component/View/Style/Theme.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <!-- Bool to Visibility Converter -->
            <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />

            <!-- DataGrid 스타일 -->
            <Style TargetType="DataGrid">
                <Setter Property="Background" Value="{StaticResource Brush.Surface}" />
                <Setter Property="Foreground" Value="{StaticResource Brush.Text}" />
                <Setter Property="BorderBrush" Value="{StaticResource Brush.Border}" />
                <Setter Property="GridLinesVisibility" Value="All" />
                <Setter Property="HorizontalGridLinesBrush" Value="{StaticResource Brush.Border}" />
                <Setter Property="VerticalGridLinesBrush" Value="{StaticResource Brush.Border}" />
                <Setter Property="RowBackground" Value="{StaticResource Brush.Surface}" />
                <Setter Property="AlternatingRowBackground" Value="{StaticResource Brush.Bg}" />
                <Setter Property="HeadersVisibility" Value="Column" />
                <Setter Property="AutoGenerateColumns" Value="True" />
                <Setter Property="CanUserAddRows" Value="False" />
                <Setter Property="IsReadOnly" Value="False" />
            </Style>

            <Style TargetType="DataGridColumnHeader">
                <Setter Property="Background" Value="{StaticResource Brush.Primary.Dark}" />
                <Setter Property="Foreground" Value="White" />
                <Setter Property="Padding" Value="8,6" />
                <Setter Property="BorderBrush" Value="{StaticResource Brush.Border}" />
                <Setter Property="BorderThickness" Value="0,0,1,1" />
            </Style>

            <Style TargetType="DataGridCell">
                <Setter Property="Padding" Value="6,4" />
                <Setter Property="BorderBrush" Value="{StaticResource Brush.Border}" />
                <Setter Property="BorderThickness" Value="0,0,1,0" />
                <Style.Triggers>
                    <Trigger Property="IsSelected" Value="True">
                        <Setter Property="Background" Value="{StaticResource Brush.Primary}" />
                        <Setter Property="Foreground" Value="White" />
                    </Trigger>
                </Style.Triggers>
            </Style>


            <!-- Button 스타일 -->
            <Style TargetType="Button">
                <Setter Property="Background" Value="{StaticResource Brush.Primary}" />
                <Setter Property="Foreground" Value="White" />
                <Setter Property="BorderBrush" Value="{StaticResource Brush.Primary.Dark}" />
                <Setter Property="Padding" Value="12,6" />
                <Setter Property="Cursor" Value="Hand" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="border"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Padding="{TemplateBinding Padding}">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="border" Property="Background" Value="{StaticResource Brush.Primary.Dark}" />
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter TargetName="border" Property="Background" Value="{StaticResource Brush.Border}" />
                                    <Setter Property="Foreground" Value="{StaticResource Brush.Text.Muted}" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- Label 스타일 -->
            <Style TargetType="Label">
                <Setter Property="Foreground" Value="{StaticResource Brush.Text}" />
                <Setter Property="VerticalAlignment" Value="Center" />
            </Style>

            <!-- TextBlock 스타일 -->
            <Style TargetType="TextBlock">
                <Setter Property="Foreground" Value="{StaticResource Brush.Text}" />
                <Setter Property="VerticalAlignment" Value="Center" />
            </Style>

            <!-- CheckBox 스타일 -->
            <Style TargetType="CheckBox">
                <Setter Property="Foreground" Value="{StaticResource Brush.Text}" />
                <Setter Property="VerticalAlignment" Value="Center" />
                <Setter Property="Margin" Value="4,2" />
            </Style>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid Background="{StaticResource Brush.Bg}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" MinWidth="300" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="1.5*" MinWidth="500" />
        </Grid.ColumnDefinitions>

        <!-- 좌측: 데이터 그리드 -->
        <Grid Grid.Column="0" Margin="8">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="데이터 테이블" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,8" />

            <!-- 데이터 소스 선택 -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,8">
                <Label Content="데이터 소스:" FontWeight="SemiBold" VerticalAlignment="Center" Padding="0,0,8,0" />
                <ComboBox ItemsSource="{Binding DataSourceItems}"
                          SelectedItem="{Binding SelectedDataSource}"
                          DisplayMemberPath="DisplayName"
                          MinWidth="200" />
            </StackPanel>

            <DataGrid x:Name="DataGridView"
                      Grid.Row="2"
                      ItemsSource="{Binding DataTable}"
                      CanUserSortColumns="True"
                      CanUserReorderColumns="True"
                      CanUserResizeColumns="True"
                      CanUserResizeRows="False"
                      Sorting="DataGridView_Sorting" />
        </Grid>

        <!-- GridSplitter -->
        <GridSplitter Grid.Column="1" Width="6" HorizontalAlignment="Center" VerticalAlignment="Stretch"
                      Background="{StaticResource Brush.Border}" />

        <!-- 우측: 그래프 및 컨트롤 -->
        <Grid Grid.Column="2" Margin="8">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- 축 선택 컨트롤 패널 -->
            <Border Grid.Row="0" Background="{StaticResource Brush.Surface}"
                    BorderBrush="{StaticResource Brush.Border}" BorderThickness="1"
                    CornerRadius="4" Padding="8" Margin="0,0,0,8">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- X축 선택 -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                        <Label Content="X축:" FontWeight="SemiBold" Width="50" />
                        <ComboBox ItemsSource="{Binding XAxisOptions}"
                                  SelectedIndex="{Binding SelectedXColumnIndex}"
                                  MinWidth="150" />
                    </StackPanel>

                    <!-- Y축 선택 (다중 선택 가능) -->
                    <StackPanel Grid.Row="1" Orientation="Horizontal">
                        <Label Content="Y축:" FontWeight="SemiBold" Width="50" VerticalAlignment="Top" />
                        <ScrollViewer MaxHeight="80" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                            <ItemsControl ItemsSource="{Binding YColumnSelectionItems}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <CheckBox Content="{Binding Header}"
                                                  IsChecked="{Binding IsSelected}"
                                                  Margin="4,2" />
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>

                        <!-- Z축 선택 (3D 차트용) -->
                        <StackPanel Orientation="Horizontal" Margin="24,0,0,0"
                                    Visibility="{Binding Is3DChartTypeSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                            <Label Content="Z축:" FontWeight="SemiBold" Width="40" />
                            <ComboBox ItemsSource="{Binding ColumnHeaders}"
                                      SelectedIndex="{Binding SelectedZColumnIndex}"
                                      MinWidth="120" />
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- 버튼 패널 -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,8">
                <!-- 차트 유형 선택 -->
                <Label Content="차트 유형:" FontWeight="SemiBold" VerticalAlignment="Center" />
                <ComboBox ItemsSource="{Binding ChartTypeItems}"
                          SelectedItem="{Binding SelectedChartType}"
                          DisplayMemberPath="DisplayName"
                          MinWidth="140"
                          Margin="0,0,16,0" />

                <Button Content="그래프 그리기"
                        Command="{Binding DrawGraphCommand}"
                        Margin="0,0,8,0" />

                <Button Content="회귀 분석"
                        Command="{Binding CalculateRegressionCommand}"
                        Background="{StaticResource Brush.Primary}"
                        BorderBrush="{StaticResource Brush.Primary.Dark}"
                        Margin="0,0,8,0" />

                <Button Content="최댓값 찾기"
                        Command="{Binding FindMaxCommand}"
                        Background="{StaticResource Brush.Accent}"
                        BorderBrush="{StaticResource Brush.Accent.Dark}"
                        Margin="0,0,8,0" />

                <Button Content="최솟값 찾기"
                        Command="{Binding FindMinCommand}"
                        Background="{StaticResource Brush.Accent}"
                        BorderBrush="{StaticResource Brush.Accent.Dark}"
                        Margin="0,0,8,0" />

                <CheckBox Content="회귀선 표시"
                          IsChecked="{Binding ShowRegressionLine}"
                          VerticalAlignment="Center"
                          Margin="8,0,0,0" />

                <!-- 3D 옵션 -->
                <StackPanel Orientation="Horizontal" Margin="16,0,0,0"
                            Visibility="{Binding Is3DChartTypeSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                    <CheckBox Content="와이어프레임"
                              IsChecked="{Binding ShowWireframe}"
                              VerticalAlignment="Center"
                              Margin="0,0,8,0" />
                    <CheckBox Content="3D 축"
                              IsChecked="{Binding ShowAxes3D}"
                              VerticalAlignment="Center"
                              Margin="0,0,8,0" />
                    <CheckBox Content="그리드"
                              IsChecked="{Binding ShowGridFloor}"
                              VerticalAlignment="Center" />
                </StackPanel>

                <!-- 데이터 병합 버튼 -->
                <Button Content="데이터 병합"
                        Command="{Binding MergeDataCommand}"
                        Background="#2E7D32"
                        BorderBrush="#1B5E20"
                        Margin="16,0,8,0"
                        ToolTip="다른 CSV 파일의 데이터를 현재 그래프에 오버레이합니다" />

                <Button Content="병합 초기화"
                        Command="{Binding ClearOverlayDataCommand}"
                        Background="#C62828"
                        BorderBrush="#B71C1C"
                        Margin="0,0,0,0"
                        ToolTip="병합된 데이터를 모두 제거합니다" />

                <!-- 차트 저장 버튼 -->
                <Button x:Name="SaveChartButton"
                        Content="차트 저장"
                        Click="SaveChartButton_Click"
                        Background="#5E35B1"
                        BorderBrush="#4527A0"
                        Margin="16,0,0,0"
                        ToolTip="현재 차트를 이미지 파일로 저장합니다" />
            </StackPanel>

            <!-- 차트 -->
            <Border Grid.Row="2"
                    x:Name="ChartContainer"
                    Background="{StaticResource Brush.Surface}"
                    BorderBrush="{StaticResource Brush.Border}"
                    BorderThickness="1"
                    CornerRadius="4">
                <Grid>
                    <!-- 카테시안 차트 (꺾은선, 막대, 영역, 점, 계단형) -->
                    <lvc:CartesianChart Series="{Binding ChartSeries}"
                                        XAxes="{Binding XAxes}"
                                        YAxes="{Binding YAxes}"
                                        ZoomMode="Both"
                                        TooltipPosition="Top"
                                        Visibility="{Binding IsCartesianChartVisible, Converter={StaticResource BoolToVisibilityConverter}}" />
                    <!-- 파이 차트 -->
                    <lvc:PieChart Series="{Binding PieSeries}"
                                  TooltipPosition="Center"
                                  Visibility="{Binding IsPieChartVisible, Converter={StaticResource BoolToVisibilityConverter}}" />
                    <!-- 3D 차트 -->
                    <helix:HelixViewport3D x:Name="Viewport3D"
                                           Visibility="{Binding Is3DChartVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                                           ZoomExtentsWhenLoaded="True"
                                           ShowCoordinateSystem="True"
                                           CoordinateSystemLabelForeground="White"
                                           Background="#2D2D30"
                                           ShowViewCube="True"
                                           ViewCubeBackText="후"
                                           ViewCubeFrontText="전"
                                           ViewCubeLeftText="좌"
                                           ViewCubeRightText="우"
                                           ViewCubeTopText="상"
                                           ViewCubeBottomText="하">
                        <helix:DefaultLights />
                        <ModelVisual3D Content="{Binding Chart3DModel}" />
                    </helix:HelixViewport3D>
                </Grid>
            </Border>

            <!-- 통계 정보 표시 -->
            <Border Grid.Row="3"
                    Background="{StaticResource Brush.Surface}"
                    BorderBrush="{StaticResource Brush.Border}"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="8"
                    Margin="0,8,0,0">
                <StackPanel>
                    <TextBlock Text="{Binding StatisticsText}"
                               FontSize="12"
                               Foreground="{StaticResource Brush.Text}"
                               TextWrapping="Wrap" />
                    <TextBlock Text="{Binding RegressionText}"
                               FontSize="12"
                               Foreground="{StaticResource Brush.Primary}"
                               TextWrapping="Wrap"
                               Margin="0,4,0,0" />
                    <TextBlock Text="{Binding OverlayDataInfo}"
                               FontSize="11"
                               Foreground="#4CAF50"
                               TextWrapping="Wrap"
                               Margin="0,4,0,0"
                               Visibility="{Binding HasOverlayData, Converter={StaticResource BoolToVisibilityConverter}}" />
                </StackPanel>
            </Border>

            <!-- 극값 결과 표시 -->
            <StackPanel Grid.Row="4" Orientation="Horizontal" Margin="0,8,0,0">
                <TextBlock Text="{Binding MaxValueText}"
                           FontSize="13"
                           Foreground="{StaticResource Brush.Accent}"
                           Margin="0,0,24,0" />
                <TextBlock Text="{Binding MinValueText}"
                           FontSize="13"
                           Foreground="{StaticResource Brush.Primary}" />
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
